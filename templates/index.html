<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deteksi Objek Kepadatan Kendaraan</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header class="header">
        <div class="main-container">
            <div class="header-top">
                <h1 class="header-title">Projek Utama Informatika</h1>
                <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode">
                    <span class="theme-icon dark-icon">üåô</span>
                    <span class="theme-icon light-icon">‚òÄÔ∏è</span>
                </button>
            </div>
            <p class="header-subtitle">Analisis kepadatan kendaraan  </p>
        </div>
    </header>

    <main class="main-container">
        <section class="upload-section">
            <div class="upload-card">
                <h2 class="upload-title">Unggah File Video</h2>
                <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data" class="form">
                    <fieldset class="form-fieldset">
                        <legend class="form-legend">Pilih Video</legend>
                        <div class="form-group">
                            <label for="fileInput" class="form-label">Pilih file video (MP4, AVI, MOV):</label>
                            <div class="file-input-wrapper">
                                <input type="file" name="video" id="fileInput" accept=".mp4,.avi,.mov" class="file-input" aria-describedby="fileHelp">
                                <span class="file-name">Belum ada file yang dipilih</span>
                            </div>
                            <p id="fileHelp" class="form-help">Ukuran file maksimal: 100MB</p>
                        </div>
                        <div class="form-group">
                            <label for="progressBar" class="form-label">Progres Unggah:</label>
                            <div id="progressBar" class="progress-bar hidden" aria-describedby="progressStatus">
                                <div id="progress" class="progress"></div>
                            </div>
                            <p id="progressStatus" class="form-help"></p>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="upload-button">Unggah dan Proses</button>
                        </div>
                    </fieldset>
                </form>
                <p id="uploadStatus" class="upload-status"></p>
            </div>
        </section>

        <section class="filter-container">
            <input type="text" id="searchInput" placeholder="Cari berdasarkan label (misal: mobil, truk)..." class="search-input">
            <select id="sortSelect" class="sort-select">
                <option value="newest">Urutkan berdasarkan: Terbaru</option>
                <option value="detections">Urutkan berdasarkan: Jumlah Deteksi</option>
            </select>
        </section>

        <section>
            <h2 class="upload-title">Media yang Diproses</h2>
            <div id="mediaGrid" class="media-grid"></div>
            <p id="noResults" class="hidden upload-status">Tidak ada hasil yang cocok dengan filter Anda.</p>
        </section>
    </main>

    <div id="modal" class="modal">
        <div class="modal-content">
            <button onclick="closeModal()" class="modal-close">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div id="modalContent" class="mt-4"></div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <button onclick="closeEditModal()" class="modal-close">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h3 class="modal-title">Edit Metadata Video</h3>
            <form id="editForm" class="form">
                <fieldset class="form-fieldset">
                    <legend class="form-legend">Detail Metadata</legend>
                    <input type="hidden" id="editVideoId"> <div class="form-group">
                        <label for="editLabels" class="form-label">Label (dipisahkan koma):</label>
                        <input type="text" id="editLabels" class="form-input" placeholder="misal: mobil, truk" required>
                    </div>
                    <div class="form-group">
                        <label for="editDetectionCount" class="form-label">Jumlah Deteksi:</label>
                        <input type="number" id="editDetectionCount" class="form-input" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="editAverageConfidence" class="form-label">Rata-rata Kepercayaan (0-1):</label>
                        <input type="number" id="editAverageConfidence" class="form-input" step="0.01" min="0" max="1" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-button">Simpan Perubahan</button>
                        <button type="button" class="cancel-button" onclick="closeEditModal()">Batal</button>
                    </div>
                </fieldset>
            </form>
            <p id="editStatus" class="upload-status"></p>
        </div>
    </div>

    <footer class="footer">
        <div class="main-container">
            <p class="footer-text">¬© 2025 Aplikasi Deteksi Objek YOLOv11. Semua hak dilindungi.</p>
        </div>
    </footer>

    <script>
        // Fungsionalitas Pengalihan Tema
        const themeToggle = document.getElementById('themeToggle');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        // Ambil tema dari localStorage atau tentukan berdasarkan preferensi sistem
        const currentTheme = localStorage.getItem('theme') || (prefersDarkScheme.matches ? 'dark' : 'light');
        if (currentTheme === 'dark') {
            document.body.classList.add('dark-mode');
        }

        // Tambahkan event listener untuk tombol pengalihan tema
        themeToggle.addEventListener('click', () => {
            const isDark = document.body.classList.toggle('dark-mode'); // Toggle kelas 'dark-mode'
            localStorage.setItem('theme', isDark ? 'dark' : 'light'); // Simpan preferensi tema
        });

        // Perbarui tampilan nama file saat file dipilih
        document.getElementById('fileInput').addEventListener('change', function() {
            const fileName = this.files[0]?.name || 'Belum ada file yang dipilih';
            document.querySelector('.file-name').textContent = fileName;
        });

        // Fungsi untuk mendapatkan tipe MIME dari ekstensi file
        function getMimeType(extension) {
            const mimeTypes = {
                'mp4': 'video/mp4',
                'avi': 'video/x-msvideo',
                'mov': 'video/quicktime'
            };
            return mimeTypes[extension.toLowerCase()] || 'video/mp4';
        }

        // Array global untuk menyimpan semua data video yang diproses
        let allProcessedVideos = [];

        // Fungsi untuk merender satu kartu media
        function renderMediaCard(videoData) {
            const mediaCard = document.createElement('div');
            mediaCard.className = 'media-card';
            mediaCard.dataset.id = videoData.id;
            mediaCard.dataset.labels = videoData.metadata.labels.join(',').toLowerCase();
            mediaCard.dataset.detections = videoData.metadata.detection_count;

            const mimeType = videoData.processed_file_mime_type;

            mediaCard.innerHTML = `
                <div class="media-preview-wrapper">
                    <video class="media-preview"
                           onclick="openModal('${videoData.original_url}', '${videoData.result_url}', '${mimeType}')"
                           preload="metadata">
                        <source src="${videoData.result_url}" type="${mimeType}">
                        Browser Anda tidak mendukung tag video.
                    </video>
                </div>
                <div class="media-content">
                    <h3 class="media-title">${videoData.original_filename}</h3>
                    <div class="media-details">
                        <p><strong>Label:</strong> ${videoData.metadata.labels.join(', ') || 'Tidak ada'}</p>
                        <p><strong>Deteksi:</strong> ${videoData.metadata.detection_count}</p>
                        ${videoData.metadata.average_confidence ? `<p><strong>Rata-rata Kepercayaan:</strong> ${videoData.metadata.average_confidence.toFixed(2)}</p>` : ''}
                    </div>
                    <div class="card-actions">
                        <button class="action-button edit-button" onclick="openEditModal('${videoData.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            Edit
                        </button>
                        <button class="action-button delete-button" onclick="confirmDelete('${videoData.id}', '${videoData.original_filename}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            Hapus
                        </button>
                    </div>
                </div>
            `;
            return mediaCard;
        }

        // Ambil video dari API saat halaman dimuat
        async function fetchVideos() {
            try {
                const response = await fetch('/videos');
                const data = await response.json();
                if (data.success) {
                    allProcessedVideos = data.videos;
                    filterAndSort(); // Panggil fungsi filter dan sort untuk menampilkan video
                } else {
                    console.error('Gagal mengambil video:', data.error);
                }
            } catch (error) {
                console.error('Error saat mengambil video:', error);
            }
        }

        // Panggil fetchVideos saat DOM selesai dimuat
        document.addEventListener('DOMContentLoaded', fetchVideos);

        // Unggah AJAX dengan Progress Bar
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault(); // Mencegah pengiriman form default
            const fileInput = document.getElementById('fileInput');
            const progressBar = document.getElementById('progressBar');
            const progress = document.getElementById('progress');
            const uploadStatus = document.getElementById('uploadStatus');
            const progressStatus = document.getElementById('progressStatus');

            if (!fileInput.files.length) {
                uploadStatus.textContent = 'Harap pilih file.';
                return;
            }

            progressBar.classList.remove('hidden'); // Tampilkan progress bar
            progress.style.width = '0%'; // Reset progress
            uploadStatus.textContent = 'Mengunggah dan memproses...';
            progressStatus.textContent = 'Memulai unggahan...';
            const formData = new FormData(document.getElementById('uploadForm')); // Buat FormData dari form

            try {
                const xhr = new XMLHttpRequest(); // Buat objek XMLHttpRequest
                xhr.open('POST', window.location.origin + '/upload', true); // Konfigurasi permintaan POST

                // Event listener untuk progres unggahan
                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const percent = (event.loaded / event.total) * 100;
                        progress.style.width = `${percent}%`; // Perbarui lebar progress bar
                        progressStatus.textContent = `Mengunggah: ${percent.toFixed(0)}%`; // Tampilkan persentase
                    }
                };

                // Event listener saat unggahan selesai
                xhr.onload = () => {
                    progressBar.classList.add('hidden'); // Sembunyikan progress bar
                    if (xhr.status >= 200 && xhr.status < 300) {
                        const response = JSON.parse(xhr.responseText); // Parse respons JSON
                        if (response.success) {
                            // Tampilkan hasil unggahan
                            uploadStatus.innerHTML = `
                                <div class="upload-result">
                                    <strong>Unggah Berhasil!</strong><br>
                                    <p><strong>File:</strong> ${response.original_filename}</p>
                                    <p><strong>Label:</strong> ${response.metadata.labels.join(', ') || 'Tidak ada'}</p>
                                    <p><strong>Deteksi:</strong> ${response.metadata.detection_count}</p>
                                    ${response.metadata.average_confidence ? `<p><strong>Rata-rata Kepercayaan:</strong> ${response.metadata.average_confidence.toFixed(2)}</p>` : ''}
                                </div>
                            `;
                            progressStatus.textContent = '';
                            allProcessedVideos.unshift(response); // Tambahkan video baru ke awal array
                            filterAndSort(); // Perbarui tampilan grid
                            fileInput.value = ''; // Reset input file
                            document.querySelector('.file-name').textContent = 'Belum ada file yang dipilih';
                            setTimeout(() => {
                                uploadStatus.innerHTML = ''; // Hapus status setelah 5 detik
                            }, 5000);
                        } else {
                            uploadStatus.textContent = `Error: ${response.error}`;
                            progressStatus.textContent = '';
                        }
                    } else {
                        uploadStatus.textContent = `Unggahan gagal: Server merespons dengan status ${xhr.status}`;
                        progressStatus.textContent = '';
                    }
                };

                // Event listener untuk error jaringan
                xhr.onerror = () => {
                    progressBar.classList.add('hidden');
                    uploadStatus.textContent = 'Unggahan gagal: Tidak dapat terhubung ke server.';
                    progressStatus.textContent = '';
                };

                xhr.send(formData); // Kirim FormData
            } catch (error) {
                progressBar.classList.add('hidden');
                uploadStatus.textContent = `Error: ${error.message}`;
                progressStatus.textContent = '';
            }
        });

        // Fungsi Filter dan Pengurutan
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');
        const mediaGrid = document.getElementById('mediaGrid');
        const noResults = document.getElementById('noResults');

        function filterAndSort() {
            const search = searchInput.value.toLowerCase();
            const sortBy = sortSelect.value;
            let visibleVideos = [...allProcessedVideos]; // Buat salinan array

            // Filter berdasarkan pencarian label
            if (search) {
                visibleVideos = visibleVideos.filter(video =>
                    video.metadata.labels.some(label => label.toLowerCase().includes(search))
                );
            }

            // Urutkan video
            visibleVideos.sort((a, b) => {
                if (sortBy === 'detections') {
                    return b.metadata.detection_count - a.metadata.detection_count; // Urutkan berdasarkan jumlah deteksi (menurun)
                }
                // Urutkan berdasarkan URL (terbaru, karena URL biasanya memiliki ID yang meningkat)
                return b.result_url.localeCompare(a.result_url);
            });

            mediaGrid.innerHTML = ''; // Kosongkan grid
            if (visibleVideos.length > 0) {
                visibleVideos.forEach(video => mediaGrid.appendChild(renderMediaCard(video))); // Render kartu media
                noResults.classList.add('hidden'); // Sembunyikan pesan "Tidak ada hasil"
            } else {
                noResults.classList.remove('hidden'); // Tampilkan pesan "Tidak ada hasil"
            }
        }

        // Tambahkan event listener untuk input pencarian dan pilihan pengurutan
        searchInput.addEventListener('input', filterAndSort);
        sortSelect.addEventListener('change', filterAndSort);

        // Fungsi Modal - Pratinjau Video
        function openModal(originalUrl, resultUrl, processedMimeType) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            const originalFileExt = originalUrl.split('.').pop();
            const originalMimeType = getMimeType(originalFileExt);

            modalContent.innerHTML = `
                <div class="modal-video-container">
                    <div class="video-wrapper">
                        <h3 class="video-title">Video Asli</h3>
                        <video class="modal-media" controls autoplay loop muted>
                            <source src="${originalUrl}" type="${originalMimeType}">
                            Browser Anda tidak mendukung tag video.
                        </video>
                    </div>
                    <div class="video-wrapper">
                        <h3 class="video-title">Video Hasil Deteksi</h3>
                        <video class="modal-media" controls autoplay loop muted>
                            <source src="${resultUrl}" type="${processedMimeType}">
                            Browser Anda tidak mendukung tag video.
                        </video>
                    </div>
                </div>
            `;
            modal.style.display = 'flex'; // Tampilkan modal
            setTimeout(() => {
                modal.classList.add('active'); // Tambahkan kelas 'active' untuk transisi
                modal.querySelector('.modal-content').classList.add('active');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('active'); // Hapus kelas 'active' untuk transisi
            modal.querySelector('.modal-content').classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none'; // Sembunyikan modal setelah transisi
                document.getElementById('modalContent').innerHTML = ''; // Kosongkan konten modal
            }, 300);
        }

        // Fungsi Modal - Edit Metadata
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const editVideoId = document.getElementById('editVideoId');
        const editLabels = document.getElementById('editLabels');
        const editDetectionCount = document.getElementById('editDetectionCount');
        const editAverageConfidence = document.getElementById('editAverageConfidence');
        const editStatus = document.getElementById('editStatus');

        function openEditModal(videoId) {
            const videoData = allProcessedVideos.find(v => v.id === videoId); // Cari data video
            if (!videoData) {
                editStatus.textContent = 'Data video tidak ditemukan untuk diedit.';
                return;
            }

            editVideoId.value = videoId;
            editLabels.value = videoData.metadata.labels.join(', ');
            editDetectionCount.value = videoData.metadata.detection_count;
            editAverageConfidence.value = videoData.metadata.average_confidence ? videoData.metadata.average_confidence.toFixed(2) : '';
            editStatus.textContent = ''; // Bersihkan status sebelumnya

            editModal.style.display = 'flex'; // Tampilkan modal edit
            setTimeout(() => {
                editModal.classList.add('active'); // Tambahkan kelas 'active' untuk transisi
                editModal.querySelector('.modal-content').classList.add('active');
            }, 10);
        }

        function closeEditModal() {
            editModal.classList.remove('active'); // Hapus kelas 'active' untuk transisi
            editModal.querySelector('.modal-content').classList.remove('active');
            setTimeout(() => editModal.style.display = 'none', 300); // Sembunyikan modal setelah transisi
        }

        // Event listener untuk pengiriman form edit
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const videoId = editVideoId.value;
            const updatedData = {
                labels: editLabels.value.split(',').map(label => label.trim()).filter(label => label !== ''),
                detection_count: parseInt(editDetectionCount.value, 10),
                average_confidence: parseFloat(editAverageConfidence.value) || 0
            };

            if (isNaN(updatedData.detection_count)) {
                editStatus.textContent = 'Jumlah Deteksi harus berupa angka yang valid.';
                return;
            }

            editStatus.textContent = 'Menyimpan perubahan...';

            try {
                const response = await fetch(`/videos/${videoId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedData)
                });
                const data = await response.json();

                if (data.success) {
                    editStatus.textContent = 'Perubahan berhasil disimpan!';
                    const index = allProcessedVideos.findIndex(v => v.id === videoId);
                    if (index !== -1) {
                        allProcessedVideos[index].metadata = data.metadata; // Perbarui metadata di array lokal
                    }
                    filterAndSort(); // Perbarui tampilan grid
                    setTimeout(closeEditModal, 1000); // Tutup modal setelah 1 detik
                } else {
                    editStatus.textContent = `Error: ${data.error}`;
                }
            } catch (error) {
                editStatus.textContent = `Error: ${error.message}`;
            }
        });

        // Fungsi Hapus Video
        async function confirmDelete(videoId, originalFilename) {
            // Menggunakan window.confirm() sebagai placeholder. Dalam aplikasi produksi, gunakan modal kustom.
            if (confirm(`Apakah Anda yakin ingin menghapus video ini (ID: ${videoId}, File: ${originalFilename})? Tindakan ini tidak dapat dibatalkan.`)) {
                try {
                    const response = await fetch(`/videos/${videoId}`, {
                        method: 'DELETE',
                    });
                    const data = await response.json();

                    if (data.success) {
                        alert(data.message); // Menggunakan window.alert() sebagai placeholder
                        allProcessedVideos = allProcessedVideos.filter(v => v.id !== videoId); // Hapus video dari array lokal
                        filterAndSort(); // Perbarui tampilan grid
                    } else {
                        alert(`Gagal menghapus video: ${data.error}`); // Menggunakan window.alert() sebagai placeholder
                    }
                } catch (error) {
                    alert(`Error menghapus video: ${error.message}`); // Menggunakan window.alert() sebagai placeholder
                }
            }
        }
    </script>
</body>
</html>
